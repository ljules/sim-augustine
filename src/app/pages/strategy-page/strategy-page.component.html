<div *ngIf="!simResult" class="alert alert-warning mt-3">
  Aucun résultat de simulation disponible. Lance une simulation puis reviens sur cette page.
</div>


<div class="container py-3">
   <!-- TITRE -->
   <div>
        <h2 class="mb-3">
            <i class="bi bi-stopwatch-fill me-2"></i>
            Présentation de la Stratégie
        </h2>
   </div>

    <!-- Cadre animation simulation -->
    <div class="card p-0">
        
        <!-- Entête animation -->
        <div class="card mt-0 p-3 bg-light">
            <div class="d-flex align-items-center justify-content-between ">
                <div class="fw-bold">
                    <h4>
                    <i class="bi bi-camera-video me-2"></i>
                    Animation de la simulation
                    </h4>
                </div>

                <!-- Bouton de contrôle de l'animation  -->
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-secondary btn-sm" (click)="seekStart()">
                        <i class="bi bi-rewind-circle-fill"></i>
                    </button>

                    <button type="button" class="btn btn-primary btn-sm" (click)="play()" [disabled]="isPlaying">
                        <i class="bi bi-play-circle"></i>
                    </button>

                    <button type="button" class="btn btn-primary btn-sm" (click)="pause()" [disabled]="!isPlaying">
                        <i class="bi bi-pause-circle"></i>
                    </button>

                    <button type="button" class="btn btn-secondary btn-sm" (click)="seekEnd()">
                        <i class="bi bi-fast-forward-circle-fill"></i>
                    </button>
                </div>
            </div>

            <!-- Contrôle de la vitesse de lecture & Choix avatar pilote  -->
            <div class="d-flex align-items-center mt-2 px-3">

                <!-- Bloc gauche : avatars -->
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div class="small text-muted fw-bold me-2">
                        Avatar du pilote :
                    </div>

                    <!-- Aucun avatar -->
                    <div
                        class="pilot-badge none"
                        [class.selected]="pilotBadgeFile === null"
                        (click)="onPilotBadgeChange(null)"
                        title="Aucun avatar">
                        <span>◯</span>
                    </div>

                    <!-- Avatars -->
                    <div
                        *ngFor="let badge of pilotBadges"
                        class="pilot-badge"
                        [class.selected]="pilotBadgeFile === badge"
                        (click)="onPilotBadgeChange(badge)"
                        [title]="badge">
                        <img
                            [src]="'assets/img/badges-pilote/' + badge"
                            alt="avatar pilote" />
                    </div>
                </div>

                <!-- Bloc droite : vitesse (poussé à droite) -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <div class="small text-muted fw-bold mb-0 d-none d-xl-block">
                        Vitesse :
                    </div>
                    
                    <select
                        class="form-select form-select-sm"
                        style="width: 70px;"
                        [ngModel]="playbackRate"
                        (ngModelChange)="playbackRate = $event"
                        title="Vitesse de lecture">
                        <option *ngFor="let r of playbackRates" [ngValue]="r">
                            {{ r }}x
                        </option>                        
                    </select>                    
                </div>

        </div>

            
            <div class="container ms-2 pe-4">
                <!-- Slider temps (scrub) -->
                <div class="mt-2">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div>
                            <i class="bi bi-clock me-2"></i>
                            Temps : <strong>{{ formatMmSs(currentT) }}</strong>
                        </div>
                        <div class="text-muted">/ {{ formatMmSs(durationTForUi) }}</div>
                    </div>

                    <input  type="range"
                            class="form-range"
                            [min]="0"
                            [max]="durationTForUi"
                            step="0.05"
                            [value]="currentT"
                            (input)="onTimeSliderInput($any($event.target).value)"
                    />
                </div>

                <div class="mt-2 d-flex flex-wrap gap-4">
                    <!-- Distance -->
                    <div class="small text-muted col-2">
                        <div>Distance :</div>
                        <div>{{ currentS | number:'1.0-0' }} m</div>
                    </div>
                        
                    <!-- Vitesse -->
                    <div class="col-2">
                        <div class="small text-muted">Vitesse :</div>
                        <div class="fw-semibold">
                        <span *ngIf="currentSpeedKmh !== null; else noSpeed">
                            {{ currentSpeedKmh | number:'1.0-1' }} km/h
                        </span>
                        <ng-template #noSpeed>—</ng-template>
                        </div>
                    </div>

                    <!-- PWM -->
                    <div class="col-4">
                        <div style="min-width: 120px;">
                            <div class="small text-muted d-flex justify-content-between">
                                <span>PWM</span>
                                <span class="fw-semibold">
                                    <span *ngIf="currentPwmPercent !== null; else noPwm">
                                    {{ currentPwmPercent | number:'1.0-0' }}%
                                    </span>
                                    <ng-template #noPwm>—</ng-template>
                                </span>
                            </div>

                            <div class="progress bg-info-subtle " style="height: 10px;">
                                <div
                                    class="progress-bar bg-warning"
                                    role="progressbar"
                                    [style.width.%]="currentPwmPercent ?? 0"
                                    [attr.aria-valuenow]="currentPwmPercent ?? 0"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>           

        <!-- AFFICHAGE DU CIRCUIT -->
        <app-circuit-map-component
            [s]="circuit?.s ?? []"
            [utmX]="circuit?.utmX ?? []"
            [utmY]="circuit?.utmY ?? []"
            [intervals]="cfg.intervals"
            [cursorDistance]="currentS"
            [cursorAvatarUrl]="pilotBadgeUrl">
        </app-circuit-map-component>

        <div class="mt-0 ms-4 mb-4">
            <div class="text-muted fw-bold mb-2">
                Légende :
            </div>

            <div class="d-flex flex-wrap gap-3">
                <div class="ms-4">Accélérations (durée pente (s)) :</div>
                <div                
                *ngFor="let item of slopeLegend"
                class="d-flex align-items-center gap-2"
                >
                <!-- pastille couleur -->
                <span
                    class="d-inline-block rounded"
                    [style.background]="item.color"
                    style="width: 24px; height: 12px;"
                ></span>

                <!-- texte -->
                <span class="small">
                    : {{ item.dtSlope }} s
                </span>
                </div>
            </div>
        </div>
    </div>


    <!-- TABLEAU DES CONSIGNES PILOTE -->
    <div class="card mt-3 p-0">
        <div class="p-3 bg-body-tertiary">
        <div class="align-items-center justify-content-between mb-2">
            <div class="fw-bold">
                <h4>
                <i class="bi bi-list-check me-4"></i>
                Consignes de pilotage
                </h4>
            </div>
            <div class="small text-muted" *ngIf="pilotRows.length">
                {{ pilotRows.length }} rampe(s)
            </div>
        </div>
        </div>

    <div *ngIf="!pilotRows.length" class="text-muted small m-3">
        Aucun résultat de simulation disponible.
    </div>

    <div *ngIf="pilotRows.length" class="table-responsive ms-4 me-4 mt-3">
        <table class="table table-sm align-middle">
        <thead>
            <tr>
            <th>Début</th>
            <th>Fin</th>
            <th class="text-end">Vitesse début</th>
            <th class="text-end">Vitesse fin</th>
            <th class="text-center">Couleur rampe</th>
            </tr>
        </thead>

        <tbody>
            <tr *ngFor="let r of pilotRows">
            <td>{{ formatMmSs(r.startTime) }}</td>
            <td>{{ formatMmSs(r.endTime) }}</td>

            <td class="text-end">
                <span *ngIf="r.startSpeedKmh !== null; else dash">
                {{ r.startSpeedKmh | number:'1.0-1' }} km/h
                </span>
                <ng-template #dash>—</ng-template>
            </td>

            <td class="text-end">
                <span *ngIf="r.endSpeedKmh !== null; else dash2">
                {{ r.endSpeedKmh | number:'1.0-1' }} km/h
                </span>
                <ng-template #dash2>—</ng-template>
            </td>

            <td class="text-center">
                <span
                class="d-inline-block rounded"
                [style.background]="r.color"
                style="width: 28px; height: 10px;"
                title="{{ r.color }}"
                ></span>
            </td>
            </tr>
        </tbody>
        </table>
    </div>
    </div>
</div>