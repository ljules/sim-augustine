<div class="timeline">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
      <div>
        <div class="fw-semibold">
          <i class="bi bi-sliders me-2"></i>
          Intervalles ON moteur (D → F)
        </div>
      </div>

      <!-- Paramètres par défaut + bouton d'ajout -->
      <div class="d-flex gap-3 align-items-center flex-wrap">
        <!-- dtSlope par défaut -->
        <div class="d-flex align-items-center gap-2">
          <label class="small text-muted m-0">dtSlope (s)</label>
          <input
            type="number"
            class="form-control form-control-sm dt-slope-input"
            [ngModel]="defaultDtSlope"
            (ngModelChange)="setDefaultDtSlope($event)"
            min="0"
            step="0.1"
          />
        </div>

        <!-- Couleur par défaut -->
        <div class="d-flex align-items-center gap-2">
          <label class="small text-muted m-0">Couleur</label>
          <div class="color-picker">
            <button
              type="button"
              class="color-dot dot-yellow"
              [class.active]="defaultColor === 'yellow'"
              (click)="setDefaultColor('yellow')"
              title="Bouton jaune"
            ></button>
            <button
              type="button"
              class="color-dot dot-red"
              [class.active]="defaultColor === 'red'"
              (click)="setDefaultColor('red')"
              title="Bouton rouge"
            ></button>
            <button
              type="button"
              class="color-dot dot-blue"
              [class.active]="defaultColor === 'blue'"
              (click)="setDefaultColor('blue')"
              title="Bouton bleu"
            ></button>
          </div>
        </div>

        <!-- Bouton d'ajout -->
        <button type="button" class="btn btn-warning btn-sm" (click)="addInterval()">
          <i class="bi bi-plus-circle me-1"></i> Motor On
        </button>
      </div>
    </div>

    <div class="mt-2 track-wrap ms-3 me-3">
      <div
        #track
        class="track"
        (pointermove)="onPointerMove($event)"
        (pointerup)="onPointerUp($event)"
        (pointercancel)="onPointerUp($event)"
      >
        <div class="track-inner">
          <!-- Ligne de base -->
          <div class="baseline"></div>

          <!-- Intervalles -->
          <ng-container *ngFor="let it of intervals; let i = index">
            <!-- Segment coloré -->
            <div
              class="segment"
              [ngClass]="'seg-' + it.color"
              [style.left.%]="percentFromM(it.d)"
              [style.width.%]="percentFromM(it.f) - percentFromM(it.d)"
              (pointerdown)="onPointerDownSegment($event, i)"
              title="Glisser le segment"
            ></div>

            <!-- Handle D -->
            <div
              class="handle handle-d"
              [style.left.%]="percentFromM(it.d)"
              (pointerdown)="onPointerDownHandle($event, i, 'd')"
              title="Départ ON"
            >
              <span class="badge badge-d">D</span>
              <div class="handle-value">{{ it.d | number:'1.0-0' }}</div>
            </div>

            <!-- Handle F -->
            <div
              class="handle handle-f"
              [style.left.%]="percentFromM(it.f)"
              (pointerdown)="onPointerDownHandle($event, i, 'f')"
              title="Fin ON"
            >
              <span class="badge badge-f">F</span>
              <div class="handle-value">{{ it.f | number:'1.0-0' }}</div>
            </div>

            <!-- Outils intervalle : dtSlope + couleur + suppression -->
            <div class="interval-tools" [style.left.%]="percentFromM((it.d + it.f) / 2)">
              <!-- dtSlope par intervalle -->
              <input
                type="number"
                class="form-control form-control-sm dt-slope-mini"
                [ngModel]="it.dtSlope"
                (ngModelChange)="setIntervalDtSlope(i, $event)"
                min="0"
                step="0.1"
                title="dtSlope (s)"
              />

              <!-- Couleur par intervalle -->
              <div class="color-picker mini">
                <button
                  type="button"
                  class="color-dot dot-yellow"
                  [class.active]="it.color === 'yellow'"
                  (click)="setIntervalColor(i, 'yellow')"
                  title="Jaune"
                ></button>
                <button
                  type="button"
                  class="color-dot dot-red"
                  [class.active]="it.color === 'red'"
                  (click)="setIntervalColor(i, 'red')"
                  title="Rouge"
                ></button>
                <button
                  type="button"
                  class="color-dot dot-blue"
                  [class.active]="it.color === 'blue'"
                  (click)="setIntervalColor(i, 'blue')"
                  title="Bleu"
                ></button>
              </div>

              <!-- Suppression -->
              <button
                type="button"
                class="btn btn-sm btn-outline-danger btn-remove"
                (click)="removeInterval(i)"
                title="Supprimer l'intervalle"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>
